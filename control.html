<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة تحكم نظام الطوابير</title>

    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #2c3e50;
            --muted: #6b7280;
            --primary: #2563eb;
            --success: #16a34a;
            --warn: #f59e0b;
            --danger: #dc2626;
        }
        * { box-sizing: border-box; }
        body {
           margin: 0;
           font-family: 'Segoe UI', Tahoma, sans-serif;
           color: var(--text);
           background-image: url("HNU COVER.jpg");
           background-size: cover;
           background-repeat: no-repeat;
           background-position: center;
           background-attachment: fixed;
           position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }
        .container {
            max-width: 1200px;
            margin: 32px auto;
            padding: 0 16px;
        }
        .card {
            background: var(--card);
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0,0,0,.08);
            padding: 24px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .left-logos {
            display: flex;
            gap: 10px;
        }
        .logo, .logo2, .logo3 {
           width: 60px;
           height: 60px;
           border-radius: 15px;
           background-size: cover;
           background-position: center;
           background-repeat: no-repeat;
        }
        .logo  { background-image: url("gam3a.png"); }
        .logo2 { background-image: url("at7ad.png"); }
        .logo3 { background-image: url("2osra.png"); }
        .title { font-size: 22px; font-weight: 800; }
        .subtitle { color: var(--muted); font-size: 14px; }
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin: 14px 0;
        }
        select, button {
            padding: 12px 18px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        select { background: #eef2ff; }
        .btn {
            box-shadow: 0 6px 16px rgba(0,0,0,.08);
            transition: .2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .hr {
            height: 1px;
            background: #e5e7eb;
            margin: 20px 0;
        }
        .info {
            font-size: 14px;
            color: var(--muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">

            <div class="header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="logo"></div>
                    <div>
                        <div class="title">لوحة تحكم نظام الطوابير — جامعة حلوان الأهلية</div>
                        <div class="subtitle">اختر مكتبًا ثم قم باستدعاء الرقم التالي أو اختر رقمًا محددًا</div>
                    </div>
                </div>

                <div class="left-logos">
                    <div class="logo2"></div>
                    <div class="logo3"></div>
                </div>
            </div>

            <div class="hr"></div>

            <div class="row">
                <label>اختر المكتب:</label>
                <select id="deskSelect">
                    <option value="1">مكتب 1</option>
                    <option value="2">مكتب 2</option>
                    <option value="3">مكتب 3</option>
                    <option value="4">مكتب 4</option>
                    <option value="5">مكتب 5</option>
                </select>

                <label>اختر الرقم:</label>
                <select id="numberSelect"></select>

                <button class="btn btn-primary" id="btnCallSelected">استدعاء الرقم المختار</button>
                <button class="btn btn-success" id="btnCallNext">استدعاء التالي</button>
                <button class="btn btn-danger" id="btnReset">اعادة الضبط</button>
            </div>
            
            <div class="hr"></div>
            <div class="info">
                حالة المكتب الحالي (<b id="currentDeskInfo">مكتب 1</b>):
                الرقم الحالي المعروض هو <b id="currentNumberInfo">-</b>.
                آخر رقم تم استدعاؤه هو <b id="lastCalledInfo">-</b>.
            </div>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDsNSCnJ5EUUd6TT7ZlM1yvBuDNkiZ8Si0",
            authDomain: "hnu-system.firebaseapp.com",
            projectId: "hnu-system",
            storageBucket: "hnu-system.firebasestorage.app",
            messagingSenderId: "461347950072",
            appId: "1:461347950072:web:76966d73d3abdff7da9a0d",
            measurementId: "G-R6SEPHNG4W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const queueStateRef = database.ref('queueState');

        const DESK_CONFIG = {
            '1': { start: 1, end: 100 },
            '2': { start: 1, end: 100 },
            '3': { start: 1, end: 100 },
            '4': { start: 1, end: 100 },
            '5': { start: 1, end: 100 },
        };

        let deskState = {};

        const deskSelect      = document.getElementById('deskSelect');
        const numberSelect    = document.getElementById('numberSelect');
        const btnCallSelected = document.getElementById('btnCallSelected');
        const btnCallNext     = document.getElementById('btnCallNext');
        const btnReset        = document.getElementById('btnReset');
        
        const currentDeskInfo   = document.getElementById('currentDeskInfo');
        const currentNumberInfo = document.getElementById('currentNumberInfo');
        const lastCalledInfo    = document.getElementById('lastCalledInfo');

        // Function to save the entire state to Firebase
        function saveStateToFirebase() {
            queueStateRef.set(deskState);
        }

        // Listen for state changes from Firebase
        queueStateRef.on('value', (snapshot) => {
            const state = snapshot.val();
            if (state && typeof state === 'object' && state['1']) {
                deskState = state;
            } else {
                // Initialize state if it's not in Firebase
                for (const deskId in DESK_CONFIG) {
                    deskState[deskId] = { current: null, lastCalled: null };
                }
            }
            render();
        });

        function speakNumber(number, desk){
            const msg = new SpeechSynthesisUtterance(`الرقم ${number} يتوجه إلى مكتب ${desk}`);
            msg.lang='ar-EG';
            speechSynthesis.speak(msg);
        }

        deskSelect.onchange = () => {
            updateNumberDropdown();
            render();
        };

        btnCallNext.onclick = () => {
            const deskId = deskSelect.value;
            const config = DESK_CONFIG[deskId];
            let last = deskState[deskId].lastCalled;
            let nextNumber = (last === null || last >= config.end) ? config.start : last + 1;
            deskState[deskId].current = nextNumber;
            deskState[deskId].lastCalled = nextNumber;
            saveStateToFirebase();
            speakNumber(nextNumber, deskId);
        };

        btnCallSelected.onclick = () => {
            const deskId = deskSelect.value;
            const selectedNumber = parseInt(numberSelect.value, 10);
            if (isNaN(selectedNumber)) return;
            deskState[deskId].current = selectedNumber;
            deskState[deskId].lastCalled = selectedNumber;
            saveStateToFirebase();
            speakNumber(selectedNumber, deskId);
        };

        btnReset.onclick = () => {
            const deskId = deskSelect.value;
            deskState[deskId].current = null;
            deskState[deskId].lastCalled = null;
            saveStateToFirebase();
        };

        function updateNumberDropdown() {
            const deskId = deskSelect.value;
            const config = DESK_CONFIG[deskId];
            numberSelect.innerHTML = '';
            for (let i = config.start; i <= config.end; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                numberSelect.appendChild(option);
            }
        }

        function render() {
            const deskId = deskSelect.value;
            if (!deskState[deskId]) { // Ensure state for desk exists
                 deskState[deskId] = { current: null, lastCalled: null };
            }
            const state = deskState[deskId];
            currentDeskInfo.textContent = `مكتب ${deskId}`;
            currentNumberInfo.textContent = state.current ?? '-';
            lastCalledInfo.textContent = state.lastCalled ?? '-';
        }

        updateNumberDropdown();
        render();

        window.addEventListener('keydown', (e) => {
            let targetDesk = null;
            switch (e.key) {
                case 'a': targetDesk = '1'; break;
                case 'b': targetDesk = '2'; break;
                case 'c': targetDesk = '3'; break;
                case 'd': targetDesk = '4'; break;
                case 'e': targetDesk = '5'; break;
            }
            if (targetDesk) {
                e.preventDefault();
                if (deskSelect.value !== targetDesk) {
                    deskSelect.value = targetDesk;
                    deskSelect.dispatchEvent(new Event('change'));
                }
                setTimeout(() => {
                    btnCallNext.click();
                }, 50);
            }
        });
    </script>
</body>
</html>